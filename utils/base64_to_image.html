<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Base64 → image</title>
  <style>
      body { font-family: system-ui, -apple-system, sans-serif; padding: 16px; }
      textarea { width: 100%; height: 220px; }
      button, select { margin-top: 8px; margin-right: 8px; }
      img { display: block; max-width: 100%; margin-top: 16px; border: 1px solid #ddd; }
      .row { margin-top: 8px; }
      .muted { opacity: .7; }
  </style>
</head>
<body>
<h3>Base64 → Image (local)</h3>

<div class="row">
  <label class="muted">Формат (у тебя из сервиса сейчас PNG): </label>
  <select id="mime">
    <option value="image/png" selected>image/png</option>
    <option value="image/jpeg">image/jpeg</option>
    <option value="image/webp">image/webp</option>
  </select>
</div>

<div class="row">
  <textarea id="b64" placeholder="Вставь result_base64 сюда..."></textarea>
</div>

<div class="row">
  <button id="render">Render</button>
  <button id="download" disabled>Download</button>
  <span id="info" class="muted"></span>
</div>

<img id="preview" alt="preview will appear here" />

<script>
  const b64El = document.getElementById('b64');
  const mimeEl = document.getElementById('mime');
  const imgEl = document.getElementById('preview');
  const infoEl = document.getElementById('info');
  const dlBtn = document.getElementById('download');

  function stripDataUrlPrefix(s) {
    s = (s || '').trim();
    if (s.startsWith('data:')) {
      const idx = s.indexOf(',');
      return idx >= 0 ? s.slice(idx + 1) : '';
    }
    return s;
  }

  function makeDataUrl(base64, mime) {
    return `data:${mime};base64,${base64}`;
  }

  document.getElementById('render').addEventListener('click', () => {
    const mime = mimeEl.value;
    const b64 = stripDataUrlPrefix(b64El.value).replace(/\s+/g, '');
    if (!b64) {
      infoEl.textContent = 'Пусто.';
      dlBtn.disabled = true;
      imgEl.removeAttribute('src');
      return;
    }

    const dataUrl = makeDataUrl(b64, mime);
    imgEl.src = dataUrl;
    dlBtn.disabled = false;

    infoEl.textContent = `base64 length: ${b64.length}`;
  });

  document.getElementById('download').addEventListener('click', () => {
    const mime = mimeEl.value;
    const b64 = stripDataUrlPrefix(b64El.value).replace(/\s+/g, '');
    if (!b64) return;

    const ext = mime === 'image/png' ? 'png' : (mime === 'image/jpeg' ? 'jpg' : 'webp');
    const a = document.createElement('a');
    a.href = makeDataUrl(b64, mime);
    a.download = `result.${ext}`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });
</script>
</body>
</html>
